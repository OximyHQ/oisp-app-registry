name: Validate

on:
  pull_request:
    paths:
      - 'apps/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Validate YAML files
        run: |
          python3 << 'EOF'
          import yaml
          import sys
          from pathlib import Path

          errors = []
          required_fields = ['id', 'name', 'signatures']
          valid_ai = ['native', 'enabled', 'host', 'none']

          for f in Path('apps').glob('*.yaml'):
              try:
                  with open(f) as fp:
                      app = yaml.safe_load(fp)

                  # Check required fields
                  for field in required_fields:
                      if field not in app:
                          errors.append(f"{f}: missing required field '{field}'")

                  # Check AI status
                  if 'ai' in app and app['ai'] not in valid_ai:
                      errors.append(f"{f}: invalid ai status '{app['ai']}' (must be one of {valid_ai})")

                  # Check signatures structure
                  if 'signatures' in app:
                      sigs = app['signatures']
                      if not isinstance(sigs, dict):
                          errors.append(f"{f}: signatures must be an object")
                      elif not any(k in sigs for k in ['macos', 'windows', 'linux']):
                          errors.append(f"{f}: signatures must have at least one platform")

              except Exception as e:
                  errors.append(f"{f}: {e}")

          if errors:
              print("Validation errors:")
              for e in errors:
                  print(f"  - {e}")
              sys.exit(1)
          else:
              print(f"All {len(list(Path('apps').glob('*.yaml')))} app files valid")
          EOF

      - name: Check for duplicate IDs
        run: |
          python3 << 'EOF'
          import yaml
          from pathlib import Path
          from collections import Counter

          ids = []
          for f in Path('apps').glob('*.yaml'):
              with open(f) as fp:
                  app = yaml.safe_load(fp)
                  if 'id' in app:
                      ids.append((app['id'], f))

          dupes = [id for id, count in Counter([i[0] for i in ids]).items() if count > 1]
          if dupes:
              print("Duplicate app IDs found:")
              for d in dupes:
                  files = [str(f) for id, f in ids if id == d]
                  print(f"  - {d}: {files}")
              exit(1)
          else:
              print(f"No duplicate IDs among {len(ids)} apps")
          EOF
